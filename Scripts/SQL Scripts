-- SQL Script for Data Cleaning, Preparation, and Analysis
-- Data Extraction Date: 30/05/2024

-- Data Cleaning
-- Removing Blank Rows
DELETE FROM table WHERE ROW IS NULL;

-- Removing Duplicate Rows
DELETE FROM table WHERE COLUMN IN (SELECT COLUMN FROM table GROUP BY COLUMN HAVING COUNT(*) > 1);

-- Filtering Unwanted Rows
DELETE FROM table WHERE REGEXP_CONTAINS(ROW, 'totals');

-- Data Formatting and Manipulation
-- Example SQL commands used for formatting and manipulation
SELECT
  COLUMN1,
  COLUMN2,
  SUM(COLUMN3) AS TOTAL_COLUMN3
FROM
  table
GROUP BY
  COLUMN1,
  COLUMN2
ORDER BY
  TOTAL_COLUMN3 DESC;

-- Specific Analyses

-- Evolution of Policies Quantity by Year
SELECT 
  ANO_DA_APOLICE,
  SUM(APOLICES_CONTRATADAS) AS TOTAL_APOLICES
FROM 
  DATA_PORTFOLIO_423423.PROJECT_2006_2023_PSR.2006_2023_GEO
GROUP BY 
  ANO_DA_APOLICE
ORDER BY 
  ANO_DA_APOLICE;

-- Ranking of Brazilian States (Top 10)
SELECT
  UF,
  SUM(APOLICES_CONTRATADAS) AS RANKING_UF_10
FROM
  DATA_PORTFOLIO_423423.PROJECT_2006_2023_PSR.2006_2023_GEO
GROUP BY
  UF
ORDER BY  
  RANKING_UF_10 DESC
LIMIT 10;

-- Ranking of Brazilian Cities (Top 10)
SELECT  
  MUNICIPIO AS CITY,
  UF,
  SUM(APOLICES_CONTRATADAS) AS RANKING_CITY
FROM
  DATA_PORTFOLIO_423423.PROJECT_2006_2023_PSR.2006_2023_GEO
GROUP BY
  CITY,
  UF
ORDER BY  
  RANKING_CITY DESC
LIMIT 10;

-- Dynamics of Insurer Ranking (2006-2023)
SELECT 
  SEGURADORA,
  ANO_DA_APOLICE, 
  SUM(APOLICES_CONTRATADAS) AS TOTAL_SEGURADORA
FROM 
  DATA_PORTFOLIO_423423.PROJECT_2006_2023_PSR.2006_2023_GEO
GROUP BY
  SEGURADORA,
  ANO_DA_APOLICE
ORDER BY
  TOTAL_SEGURADORA DESC;

-- Top 5 Insurers with the Greatest Growth
WITH SEGURADORA_POR_ANO AS (
  SELECT  
    ANO_DA_APOLICE,
    SEGURADORA,
    SUM(APOLICES_CONTRATADAS) AS SEGURADORA_RANKING
  FROM
    DATA_PORTFOLIO_423423.PROJECT_2006_2023_PSR.2006_2023_GEO
  GROUP BY
    ANO_DA_APOLICE,
    SEGURADORA
),
INICIO_FIM_SEGURADORAS AS (
  SELECT
    SEGURADORA,
    MIN(ANO_DA_APOLICE) AS ANO_INICIO_SEGURADORA,
    MAX(ANO_DA_APOLICE) AS ANO_FIM_SEGURADORA
  FROM
    SEGURADORA_POR_ANO
  GROUP BY
    SEGURADORA
),
SEGURADORA_INICIO_FIM AS (
  SELECT
    A.SEGURADORA,
    A.SEGURADORA_RANKING AS RANKING_INICIO,
    B.SEGURADORA_RANKING AS RANKING_FIM,
    C.ANO_INICIO_SEGURADORA,
    C.ANO_FIM_SEGURADORA
  FROM
    SEGURADORA_POR_ANO A
  JOIN
    INICIO_FIM_SEGURADORAS C ON A.SEGURADORA = C.SEGURADORA AND A.ANO_DA_APOLICE = C.ANO_INICIO_SEGURADORA
  JOIN
    SEGURADORA_POR_ANO B ON A.SEGURADORA = B.SEGURADORA AND B.ANO_DA_APOLICE = C.ANO_FIM_SEGURADORA
)
SELECT
  SEGURADORA,
  ANO_INICIO_SEGURADORA AS ANO_INICIO,
  ANO_FIM_SEGURADORA AS ANO_FIM,
  RANKING_INICIO,
  RANKING_FIM,
  (RANKING_FIM - RANKING_INICIO) AS AUMENTO_ABSOLUTO
FROM
  SEGURADORA_INICIO_FIM
ORDER BY
  AUMENTO_ABSOLUTO DESC
LIMIT 5;

-- Market Share of Insurers (2006-2023)
SELECT 
  SEGURADORA,
  ANO_DA_APOLICE, 
  SUM(APOLICES_CONTRATADAS) AS TOTAL_SEGURADORA
FROM 
  DATA_PORTFOLIO_423423.PROJECT_2006_2023_PSR.2006_2023_GEO
GROUP BY
  SEGURADORA,
  ANO_DA_APOLICE
ORDER BY
  TOTAL_SEGURADORA DESC;

-- Insurers that Started and Ended Activities
WITH INICIO_ENCERRAMENTO_ATIVIDADES AS (
  SELECT
    SEGURADORA,
    MIN(ANO_DA_APOLICE) AS ANO_INICIO_ATIVIDADE,
    MAX(ANO_DA_APOLICE) AS ANO_ENCERRAMENTO_ATIVIDADE
  FROM
    DATA_PORTFOLIO_423423.PROJECT_2006_2023_PSR.2006_2023_GEO
  GROUP BY
    SEGURADORA
)
SELECT
  SEGURADORA,
  ANO_INICIO_ATIVIDADE,
  ANO_ENCERRAMENTO_ATIVIDADE
FROM
  INICIO_ENCERRAMENTO_ATIVIDADES
WHERE
  ANO_ENCERRAMENTO_ATIVIDADE != 2023
ORDER BY
  SEGURADORA;

-- Concentration of Policies by Insurer in Different States
WITH SEGURADORA_POR_UF AS (
  SELECT
    SEGURADORA,
    UF,
    SUM(APOLICES_CONTRATADAS) AS TOTAL_APOLICES
  FROM 
    DATA_PORTFOLIO_423423.PROJECT_2006_2023_PSR.2006_2023_GEO
  GROUP BY 
    SEGURADORA, UF
)
SELECT
  UF,
  ARRAY_AGG(SEGURADORA ORDER BY TOTAL_APOLICES DESC LIMIT 1)[OFFSET(0)] AS SEGURADORA_LIDER,
  MAX(TOTAL_APOLICES) AS TOTAL_APOLICES
FROM 
  SEGURADORA_POR_UF
GROUP BY 
  UF
ORDER BY 
  UF;

-- Evolution of Agricultural Policy Contracting by Activity by Year
SELECT  
  ANO_DA_APOLICE,
  ATIVIDADE,
  SUM(APOLICES_CONTRATADAS) AS ATIVIDADE_RANKING
FROM
  DATA_PORTFOLIO_423423.PROJECT_2006_2023_PSR.2006_2023_GEO
GROUP BY
  ANO_DA_APOLICE,
  ATIVIDADE
ORDER BY  
  ANO_DA_APOLICE ASC;

-- Activities with the Greatest Increase in Policy Contracting
WITH ATIVIDADE_POR_ANO AS (
  SELECT  
    ANO_DA_APOLICE,
    ATIVIDADE,
    SUM(APOLICES_CONTRATADAS) AS ATIVIDADE_RANKING
  FROM
    DATA_PORTFOLIO_423423.PROJECT_2006_2023_PSR.2006_2023_GEO
  GROUP BY
    ANO_DA_APOLICE,
    ATIVIDADE
),
INICIO_FIM_ATIVIDADES AS (
  SELECT
    ATIVIDADE,
    MIN(ANO_DA_APOLICE) AS ANO_INICIO_ATIVIDADE,
    MAX(ANO_DA_APOLICE) AS ANO_FIM_ATIVIDADE
  FROM
    ATIVIDADE_POR_ANO
  GROUP BY
    ATIVIDADE
),
ATIVIDADE_INICIO_FIM AS (
  SELECT
    A.ATIVIDADE,
    A.ATIVIDADE_RANKING AS RANKING_INICIO,
    B.ATIVIDADE_RANKING AS RANKING_FIM,
    C.ANO_INICIO_ATIVIDADE,
    C.ANO_FIM_ATIVIDADE
  FROM
    ATIVIDADE_POR_ANO A
  JOIN
    INICIO_FIM_ATIVIDADES C ON A.ATIVIDADE = C.ATIVIDADE AND A.ANO_DA_APOLICE = C.ANO_INICIO_ATIVIDADE
  JOIN
    ATIVIDADE_POR_ANO B ON A.ATIVIDADE = B.ATIVIDADE AND B.ANO_DA_APOLICE = C.ANO_FIM_ATIVIDADE
)
SELECT
  ATIVIDADE,
  ANO_INICIO_ATIVIDADE AS ANO_INICIO,
  ANO_FIM_ATIVIDADE AS ANO_FIM,
  RANKING_INICIO,
  RANKING_FIM,
  (RANKING_FIM - RANKING_INICIO) AS AUMENTO_ABSOLUTO
FROM
  ATIVIDADE_INICIO_FIM
ORDER BY
  AUMENTO_ABSOLUTO DESC
LIMIT 5;

-- States with their Predominant Activity
WITH ATIVIDADE_POR_UF AS (
  SELECT
    ATIVIDADE,
    UF,
    SUM(APOLICES_CONTRATADAS) AS TOTAL_APOLICES
  FROM 
    DATA_PORTFOLIO_423423.PROJECT_2006_2023_PSR.2006_2023_GEO
  GROUP BY 
    ATIVIDADE, UF
)
SELECT
  UF,
  ARRAY_AGG(ATIVIDADE ORDER BY TOTAL_APOLICES DESC LIMIT 1)[OFFSET(0)] AS ATIVIDADE_LIDER,
  MAX(TOTAL_APOLICES) AS TOTAL_APOLICES
FROM 
  ATIVIDADE_POR_UF
GROUP BY 
  UF
ORDER BY 
  UF;

